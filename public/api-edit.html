<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit API - Kebapi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; background: #f5f5f5; color: #1a1a1a; }
        .top-bar { background: #f5f5f5; padding: 12px 32px; display: flex; align-items: center; justify-content: space-between; font-size: 13px; color: #666; border-bottom: 1px solid #e8e8e8; }
        .breadcrumb { display: flex; align-items: center; gap: 8px; }
        .breadcrumb a { color: #666; text-decoration: none; }
        .breadcrumb a:hover { color: #FF5722; }
        .header { padding: 40px 32px; display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 24px; font-weight: 300; letter-spacing: 8px; text-transform: uppercase; }
        .hero { margin: 0 32px 60px; background: #1a1a1a; border-radius: 24px; padding: 60px; color: white; }
        .api-badge { display: inline-block; padding: 6px 12px; background: #FF5722; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 16px; }
        .api-name { font-size: 48px; font-weight: 300; margin-bottom: 16px; }
        .api-description { font-size: 18px; opacity: 0.8; margin-bottom: 32px; }
        .api-url-box { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; display: flex; align-items: center; justify-content: space-between; }
        .api-url { font-family: 'Monaco', monospace; font-size: 16px; color: #FF5722; }
        .btn-copy { padding: 10px 20px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.2s; }
        .btn-copy:hover { background: #FF5722; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 32px 80px; }
        .section { background: white; border-radius: 20px; padding: 40px; margin-bottom: 24px; }
        .section-title { font-size: 24px; font-weight: 500; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; }
        .section-title i { color: #FF5722; }
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        .form-input, .form-textarea { width: 100%; padding: 12px 16px; border: 1px solid #e8e8e8; border-radius: 10px; font-size: 14px; font-family: inherit; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: #FF5722; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .btn-primary { padding: 12px 24px; background: #1a1a1a; color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary:hover { background: #FF5722; }
        .btn-danger { padding: 12px 24px; background: #EF4444; color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-danger:hover { background: #DC2626; }
        .btn-secondary { padding: 12px 24px; background: #e8e8e8; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-secondary:hover { background: #dcdcdc; }
        .actions-bar { display: flex; gap: 12px; justify-content: space-between; }
        .spinner { width: 24px; height: 24px; border: 3px solid #e8e8e8; border-top-color: #FF5722; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .alert { padding: 16px; border-radius: 10px; margin-bottom: 24px; font-size: 14px; }
        .alert-success { background: #ECFDF5; color: #065F46; }
        .alert-error { background: #FEE2E2; color: #991B1B; }
        .hidden { display: none !important; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #f5f5f5; padding: 12px; text-align: left; font-size: 12px; font-weight: 500; text-transform: uppercase; color: #666; }
        .data-table td { padding: 16px 12px; border-top: 1px solid #e8e8e8; font-size: 14px; }
        .data-table tr:hover { background: #fafafa; }
        .btn-manage-data { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-manage-data:hover { background: #5568d3; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="breadcrumb">
            <a href="/">Dashboard</a>
            <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
            <span id="breadcrumbApi">Edit API</span>
        </div>
        <span style="font-size: 12px; color: #999;">EN</span>
    </div>

    <header class="header">
        <a href="/" class="logo" style="text-decoration: none; color: inherit;">KEBAPI</a>
    </header>

    <section class="hero">
        <div class="api-badge" id="projectBadge">Loading...</div>
        <h1 class="api-name" id="apiName">Loading...</h1>
        <p class="api-description" id="apiDescription">Loading...</p>
        <div class="api-url-box">
            <code class="api-url" id="apiUrl">https://...</code>
            <button class="btn-copy" onclick="copyUrl()">
                <i class="fas fa-copy"></i> Copy
            </button>
        </div>
    </section>

    <div class="container">
        <div id="alertContainer"></div>

        <!-- Edit Details -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-edit"></i>
                Edit Details
            </h2>
            <div class="form-group">
                <label class="form-label">Project Name</label>
                <input type="text" id="projectInput" class="form-input" placeholder="e.g., entertainment">
            </div>
            <div class="form-group">
                <label class="form-label">Endpoint Name</label>
                <input type="text" id="endpointInput" class="form-input" placeholder="e.g., movies">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="descriptionInput" class="form-textarea" placeholder="Brief description of your API"></textarea>
            </div>
            <button class="btn-primary" onclick="saveChanges()">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>

        <!-- Manage Data -->
        <div class="section" id="manageDataSection">
            <h2 class="section-title">
                <i class="fas fa-database"></i>
                Manage Data
            </h2>
            <p style="color: #666; margin-bottom: 24px;">View and edit the data for this API endpoint.</p>
            <button class="btn-manage-data" onclick="openDataManager()">
                <i class="fas fa-table"></i> Open Data Manager
            </button>
        </div>

        <!-- Danger Zone -->
        <div class="section" style="border: 2px solid #FEE2E2;">
            <h2 class="section-title" style="color: #EF4444;">
                <i class="fas fa-exclamation-triangle"></i>
                Danger Zone
            </h2>
            <p style="color: #666; margin-bottom: 24px;">Once you delete an API, there is no going back. Please be certain.</p>
            <button class="btn-danger" onclick="deleteAPI()">
                <i class="fas fa-trash"></i> Delete This API
            </button>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        const SUPABASE_URL = 'https://nugcshddtrufgciosrsq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51Z2NzaGRkdHJ1ZmdjaW9zcnNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTUyMTMsImV4cCI6MjA4MTIzMTIxM30.1ECmZ8bG8HasOZ6pH_b3atPg6i9dxTRcPPUXehbiixY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let apiData = null;
        const urlParams = new URLSearchParams(window.location.search);
        const apiId = urlParams.get('id');

        async function loadAPI() {
            if (!apiId) {
                showAlert('Invalid API ID', 'error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('endpoints')
                    .select('*')
                    .eq('id', apiId)
                    .single();

                if (error || !data) {
                    showAlert('API not found', 'error');
                    return;
                }

                apiData = data;
                renderAPI();
            } catch (error) {
                console.error('Error loading API:', error);
                showAlert('Error loading API', 'error');
            }
        }

        function renderAPI() {
            document.getElementById('projectBadge').textContent = apiData.project_name;
            document.getElementById('apiName').textContent = apiData.path.replace('/', '').toUpperCase() + ' API';
            document.getElementById('apiDescription').textContent = apiData.description;
            document.getElementById('apiUrl').textContent = `${API_URL}/api/${apiData.project_name}${apiData.path}`;
            document.getElementById('breadcrumbApi').textContent = apiData.path.replace('/', '').toUpperCase();

            document.getElementById('projectInput').value = apiData.project_name;
            document.getElementById('endpointInput').value = apiData.path.replace('/', '');
            document.getElementById('descriptionInput').value = apiData.description;

            if (!apiData.schema) {
                document.getElementById('manageDataSection').style.display = 'none';
            }
        }

        async function saveChanges() {
            const project_name = document.getElementById('projectInput').value.trim();
            const endpoint_name = document.getElementById('endpointInput').value.trim();
            const description = document.getElementById('descriptionInput').value.trim();

            if (!project_name || !endpoint_name || !description) {
                showAlert('All fields are required', 'error');
                return;
            }

            const new_path = `/${endpoint_name}`;

            try {
                const { error } = await supabase
                    .from('endpoints')
                    .update({
                        project_name: project_name,
                        path: new_path,
                        description: description
                    })
                    .eq('id', apiId);

                if (error) throw error;

                showAlert('Changes saved successfully!', 'success');
                
                // Recargar despuÃ©s de 1 segundo
                setTimeout(() => {
                    window.location.reload();
                }, 1000);

            } catch (error) {
                console.error('Error:', error);
                showAlert('Error saving changes: ' + error.message, 'error');
            }
        }

        function openDataManager() {
            window.location.href = `/?open-data-manager=${apiId}`;
        }

        async function deleteAPI() {
            if (!confirm('Are you ABSOLUTELY sure? This action cannot be undone.')) {
                return;
            }

            if (!confirm('Last warning: This will permanently delete this API and all its data. Continue?')) {
                return;
            }

            try {
                // Eliminar items primero
                await supabase
                    .from('endpoint_items')
                    .delete()
                    .eq('endpoint_id', apiId);

                // Eliminar endpoint
                const { error } = await supabase
                    .from('endpoints')
                    .delete()
                    .eq('id', apiId);

                if (error) throw error;

                showAlert('API deleted successfully', 'success');
                
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);

            } catch (error) {
                console.error('Error:', error);
                showAlert('Error deleting API: ' + error.message, 'error');
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function copyUrl() {
            const url = document.getElementById('apiUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                const btn = event.target.closest('.btn-copy');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }

        loadAPI();
    </script>
</body>
</html>
