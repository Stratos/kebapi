<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace - KEBAPI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "SF Pro Display", sans-serif; background: #fafafa; color: #1a1a1a; }
        
        /* Header */
        .header { background: white; border-bottom: 1px solid #eee; padding: 20px 0; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1400px; margin: 0 auto; padding: 0 24px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: 700; color: #FF5722; text-decoration: none; }
        .back-btn { padding: 10px 20px; background: #f5f5f5; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; text-decoration: none; color: #1a1a1a; }
        .back-btn:hover { background: #FF5722; color: white; }
        
        /* Hero */
        .hero { background: linear-gradient(135deg, #FF5722 0%, #FF8A65 100%); color: white; padding: 60px 24px; text-align: center; }
        .hero-title { font-size: 48px; font-weight: 700; margin-bottom: 16px; }
        .hero-description { font-size: 18px; opacity: 0.9; margin-bottom: 40px; }
        .hero-stats { display: flex; gap: 40px; justify-content: center; flex-wrap: wrap; }
        .stat { text-align: center; }
        .stat-number { font-size: 32px; font-weight: 700; }
        .stat-label { font-size: 14px; opacity: 0.8; margin-top: 4px; }
        
        /* Filters */
        .filters { max-width: 1400px; margin: -30px auto 40px; padding: 0 24px; position: relative; z-index: 10; }
        .filters-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .search-bar { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-input { flex: 1; min-width: 250px; padding: 14px 20px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 15px; }
        .search-input:focus { outline: none; border-color: #FF5722; }
        .category-select { padding: 14px 20px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 15px; cursor: pointer; background: white; min-width: 200px; }
        .category-select:focus { outline: none; border-color: #FF5722; }
        .sort-select { padding: 14px 20px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 15px; cursor: pointer; background: white; min-width: 180px; }
        
        .category-tabs { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; -webkit-overflow-scrolling: touch; }
        .category-tabs::-webkit-scrollbar { height: 6px; }
        .category-tabs::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }
        .category-tab { padding: 8px 16px; border-radius: 20px; background: #f5f5f5; border: none; font-size: 14px; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .category-tab:hover { background: #e0e0e0; }
        .category-tab.active { background: #FF5722; color: white; }
        
        /* Container */
        .container { max-width: 1400px; margin: 0 auto; padding: 0 24px 60px; }
        
        /* Grid */
        .apis-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 24px; margin-top: 24px; }
        
        /* API Card */
        .api-card { background: white; border-radius: 16px; padding: 24px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .api-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        
        .api-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .api-icon { width: 48px; height: 48px; background: #FFF3E0; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #FF5722; font-size: 20px; }
        .api-category-badge { padding: 4px 12px; background: #f5f5f5; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; color: #666; }
        
        .api-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1a1a1a; }
        .api-description { font-size: 14px; color: #666; margin-bottom: 16px; line-height: 1.6; flex: 1; }
        
        .api-meta { display: flex; gap: 16px; margin-bottom: 16px; font-size: 12px; color: #999; flex-wrap: wrap; }
        .api-meta-item { display: flex; align-items: center; gap: 6px; }
        
        .api-url { background: #f5f5f5; border-radius: 8px; padding: 10px 12px; margin-bottom: 16px; }
        .api-url code { font-size: 11px; color: #666; word-break: break-all; }
        
        .api-author { font-size: 13px; color: #666; margin-bottom: 16px; }
        .api-author strong { color: #FF5722; }
        
        .api-actions { display: flex; gap: 8px; }
        .btn-primary { flex: 1; padding: 12px; background: #FF5722; color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary:hover { background: #E64A19; transform: translateY(-1px); }
        .btn-secondary { padding: 12px 16px; background: #f5f5f5; color: #666; border: none; border-radius: 10px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .btn-secondary:hover { background: #e0e0e0; }
        
        /* Loading */
        .loading { text-align: center; padding: 60px 24px; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #FF5722; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 80px 24px; }
        .empty-icon { font-size: 64px; color: #ddd; margin-bottom: 16px; }
        .empty-title { font-size: 24px; font-weight: 600; color: #666; margin-bottom: 8px; }
        .empty-description { font-size: 16px; color: #999; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 32px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-title { font-size: 24px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .modal-close:hover { color: #666; }
        .code-block { background: #f5f5f5; border-radius: 8px; padding: 16px; margin: 16px 0; overflow-x: auto; }
        .code-block code { font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; color: #1a1a1a; white-space: pre-wrap; word-break: break-all; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .hero-title { font-size: 32px; }
            .hero-description { font-size: 16px; }
            .hero-stats { gap: 24px; }
            .stat-number { font-size: 24px; }
            
            .filters-card { padding: 16px; }
            .search-bar { flex-direction: column; }
            .search-input, .category-select, .sort-select { width: 100%; min-width: auto; }
            
            .apis-grid { grid-template-columns: 1fr; gap: 16px; }
            
            .api-card { padding: 20px; }
            .api-meta { gap: 12px; }
            .api-actions { flex-direction: column; }
            .btn-primary, .btn-secondary { width: 100%; }
            
            .header-content { flex-direction: column; gap: 16px; text-align: center; }
        }
        
        @media (max-width: 480px) {
            .hero { padding: 40px 16px; }
            .container { padding: 0 16px 40px; }
            .filters { padding: 0 16px; margin: -20px auto 24px; }
            .modal-content { padding: 24px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <a href="/" class="logo">KEBAPI</a>
            <a href="/" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Hero -->
    <div class="hero">
        <h1 class="hero-title">API Marketplace</h1>
        <p class="hero-description">Discover and use public APIs created by the community</p>
        <div class="hero-stats">
            <div class="stat">
                <div class="stat-number" id="totalAPIs">0</div>
                <div class="stat-label">Public APIs</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="totalCategories">6</div>
                <div class="stat-label">Categories</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="totalCreators">0</div>
                <div class="stat-label">Creators</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters">
        <div class="filters-card">
            <div class="search-bar">
                <input 
                    type="text" 
                    class="search-input" 
                    placeholder="üîç Search APIs by name, description..." 
                    id="searchInput"
                    oninput="filterAPIs()"
                >
                <select class="category-select" id="categorySelect" onchange="filterAPIs()">
                    <option value="">All Categories</option>
                    <option value="data">üìä Data & Analytics</option>
                    <option value="finance">üí∞ Finance</option>
                    <option value="social">üë• Social Media</option>
                    <option value="ecommerce">üõí E-commerce</option>
                    <option value="weather">üå§Ô∏è Weather</option>
                    <option value="other">üì¶ Other</option>
                </select>
                <select class="sort-select" id="sortSelect" onchange="filterAPIs()">
                    <option value="recent">Most Recent</option>
                    <option value="name">Name (A-Z)</option>
                    <option value="author">By Author</option>
                </select>
            </div>
            
            <div class="category-tabs">
                <button class="category-tab active" onclick="selectCategory('', event)">All</button>
                <button class="category-tab" onclick="selectCategory('data', event)">üìä Data & Analytics</button>
                <button class="category-tab" onclick="selectCategory('finance', event)">üí∞ Finance</button>
                <button class="category-tab" onclick="selectCategory('social', event)">üë• Social</button>
                <button class="category-tab" onclick="selectCategory('ecommerce', event)">üõí E-commerce</button>
                <button class="category-tab" onclick="selectCategory('weather', event)">üå§Ô∏è Weather</button>
                <button class="category-tab" onclick="selectCategory('other', event)">üì¶ Other</button>
            </div>
        </div>
    </div>

    <!-- Container -->
    <div class="container">
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p style="margin-top: 16px; color: #666;">Loading APIs...</p>
        </div>

        <div id="apisGrid" class="apis-grid" style="display: none;"></div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">üîç</div>
            <h3 class="empty-title">No APIs found</h3>
            <p class="empty-description">Try adjusting your search or filters</p>
        </div>
    </div>

    <!-- Access Modal -->
    <div id="accessModal" class="modal" onclick="closeModalOnOverlay(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Access API</h2>
                <button class="modal-close" onclick="closeAccessModal()">√ó</button>
            </div>
            
            <div id="modalAPIInfo"></div>
            
            <div style="margin-top: 24px;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Quick Start</h3>
                <div class="code-block">
                    <code id="curlExample"></code>
                </div>
                
                <h3 style="font-size: 16px; font-weight: 600; margin: 20px 0 12px;">JavaScript Example</h3>
                <div class="code-block">
                    <code id="jsExample"></code>
                </div>
                
                <div style="margin-top: 24px; display: flex; gap: 12px;">
                    <button onclick="copyURL()" class="btn-primary" style="flex: 1;">
                        <i class="fas fa-copy"></i> Copy URL
                    </button>
                    <button onclick="openDocs()" class="btn-secondary">
                        <i class="fas fa-book"></i> View Docs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin.replace('http://', 'https://');
        const SUPABASE_URL = 'https://nugcshddtrufgciosrsq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51Z2NzaGRkdHJ1ZmdjaW9zcnNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTUyMTMsImV4cCI6MjA4MTIzMTIxM30.1ECmZ8bG8HasOZ6pH_b3atPg6i9dxTRcPPUXehbiixY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allAPIs = [];
        let filteredAPIs = [];
        let currentAPI = null;

        async function loadMarketplace() {
            try {
                const { data, error } = await supabase
                    .from('endpoints')
                    .select('*')
                    .eq('published', true)
                    .order('id', { ascending: false });

                if (error) throw error;

                allAPIs = data || [];
                filteredAPIs = allAPIs;

                // Update stats
                document.getElementById('totalAPIs').textContent = allAPIs.length;
                const uniqueCreators = new Set(allAPIs.map(api => api.user_email)).size;
                document.getElementById('totalCreators').textContent = uniqueCreators;

                document.getElementById('loading').style.display = 'none';
                
                if (allAPIs.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    renderAPIs();
                }
            } catch (error) {
                console.error('Error loading marketplace:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        function filterAPIs() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categorySelect').value;
            const sort = document.getElementById('sortSelect').value;

            filteredAPIs = allAPIs.filter(api => {
                const matchesSearch = !search || 
                    api.path.toLowerCase().includes(search) ||
                    api.description.toLowerCase().includes(search) ||
                    api.project_name.toLowerCase().includes(search);
                
                const matchesCategory = !category || (api.category && api.category === category);

                return matchesSearch && matchesCategory;
            });

            // Sort
            if (sort === 'name') {
                filteredAPIs.sort((a, b) => a.path.localeCompare(b.path));
            } else if (sort === 'author') {
                filteredAPIs.sort((a, b) => a.user_email.localeCompare(b.user_email));
            } else {
                // Recent (default, by id)
                filteredAPIs.sort((a, b) => (b.id || 0) - (a.id || 0));
            }

            renderAPIs();
        }

        function selectCategory(category, event) {
            document.getElementById('categorySelect').value = category;
            
            // Update active tab
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            filterAPIs();
        }

        function renderAPIs() {
            const grid = document.getElementById('apisGrid');
            const emptyState = document.getElementById('emptyState');

            if (filteredAPIs.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            grid.style.display = 'grid';

            grid.innerHTML = filteredAPIs.map(api => {
                const fullURL = `${API_URL}/api/${api.project_name}${api.path}`;
                const apiName = api.path.replace('/', '');
                const createdDate = api.created_at ? new Date(api.created_at).toLocaleDateString() : 'N/A';
                const categoryLabel = getCategoryLabel(api.category);
                const apiData = JSON.stringify(api).replace(/"/g, '&quot;');

                return `
                    <div class="api-card">
                        <div class="api-card-header">
                            <div class="api-icon">
                                <i class="fas fa-plug"></i>
                            </div>
                            ${api.category ? `<div class="api-category-badge">${categoryLabel}</div>` : ''}
                        </div>
                        
                        <h3 class="api-title">${apiName}</h3>
                        <p class="api-description">${api.description || 'No description available'}</p>
                        
                        <div class="api-meta">
                            <div class="api-meta-item">
                                <i class="fas fa-code"></i>
                                <span>${api.method}</span>
                            </div>
                            <div class="api-meta-item">
                                <i class="fas fa-calendar"></i>
                                <span>${createdDate}</span>
                            </div>
                            ${api.dataset_id ? '<div class="api-meta-item"><i class="fas fa-database"></i><span>Dataset</span></div>' : ''}
                        </div>
                        
                        <div class="api-url">
                            <code>${fullURL}</code>
                        </div>
                        
                        <div class="api-author">
                            by <strong>${api.user_email.split('@')[0]}</strong>
                        </div>
                        
                        <div class="api-actions">
                            <button class="btn-primary" onclick='openAccessModal(${apiData})'>
                                <i class="fas fa-rocket"></i> Access API
                            </button>
                            <button class="btn-secondary" onclick="window.open('/api-docs.html?project=${api.project_name}&endpoint=${apiName}', '_blank')">
                                <i class="fas fa-book"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getCategoryLabel(category) {
            const labels = {
                'data': 'üìä Data',
                'finance': 'üí∞ Finance',
                'social': 'üë• Social',
                'ecommerce': 'üõí E-commerce',
                'weather': 'üå§Ô∏è Weather',
                'other': 'üì¶ Other'
            };
            return labels[category] || '';
        }

        function openAccessModal(api) {
            currentAPI = {
                ...api,
                fullURL: `${API_URL}/api/${api.project_name}${api.path}`,
                docsURL: `/api-docs.html?project=${api.project_name}&endpoint=${api.path.replace('/', '')}`
            };

            document.getElementById('modalAPIInfo').innerHTML = `
                <div style="background: #FFF3E0; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #FF5722;">
                        ${api.path.replace('/', '')}
                    </h3>
                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">
                        ${api.description}
                    </p>
                    <div style="font-size: 13px; color: #999;">
                        <i class="fas fa-user"></i> ${api.user_email.split('@')[0]} ‚Ä¢ 
                        <i class="fas fa-code"></i> ${api.method}
                    </div>
                </div>
            `;

            document.getElementById('curlExample').textContent = `curl ${currentAPI.fullURL}`;
            
            document.getElementById('jsExample').textContent = `fetch('${currentAPI.fullURL}')
  .then(res => res.json())
  .then(data => console.log(data));`;

            document.getElementById('accessModal').classList.add('active');
        }

        function closeAccessModal() {
            document.getElementById('accessModal').classList.remove('active');
        }

        function closeModalOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeAccessModal();
            }
        }

        function copyURL() {
            navigator.clipboard.writeText(currentAPI.fullURL);
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        function openDocs() {
            window.open(currentAPI.docsURL, '_blank');
        }

        // Initialize
        loadMarketplace();
    </script>
</body>
</html>