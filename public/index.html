<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kebapi Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; background: #f5f5f5; color: #1a1a1a; }
        .auth-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: white; padding: 60px; border-radius: 20px; max-width: 440px; width: 90%; text-align: center; }
        .auth-logo { font-size: 32px; font-weight: 300; letter-spacing: 8px; text-transform: uppercase; margin-bottom: 48px; }
        .auth-title { font-size: 36px; font-weight: 300; margin-bottom: 16px; }
        .auth-subtitle { font-size: 15px; color: #666; margin-bottom: 48px; }
        .btn-google { width: 100%; padding: 16px 24px; background: #1a1a1a; border: none; border-radius: 12px; font-size: 15px; font-weight: 500; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s; }
        .btn-google:hover { background: #FF5722; transform: translateY(-2px); }
        .loading-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e8e8e8; border-top-color: #FF5722; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: white; border-right: 1px solid #e8e8e8; position: fixed; height: 100vh; display: flex; flex-direction: column; z-index: 100; transition: all 0.3s ease; }
        .sidebar.collapsed { width: 80px; }
        .sidebar.collapsed .sidebar-logo { font-size: 12px; letter-spacing: 2px; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); }
        .sidebar.collapsed .nav-item span { display: none; }
        .sidebar.collapsed .nav-label { display: none; }
        .sidebar.collapsed .user-email { display: none; }
        .sidebar.collapsed .user-avatar { margin: 0 auto; }
        .sidebar.collapsed .btn-logout { padding: 10px; font-size: 0; }
        .sidebar.collapsed .btn-logout i { margin: 0; font-size: 14px; }
        .sidebar-header { padding: 32px 24px; border-bottom: 1px solid #e8e8e8; display: flex; justify-content: space-between; align-items: center; }
        .sidebar.collapsed .sidebar-header { flex-direction: column; gap: 16px; padding: 20px 12px; }
        .sidebar-toggle { background: none; border: none; cursor: pointer; color: #666; font-size: 18px; padding: 8px; transition: all 0.2s; }
        .sidebar-toggle:hover { color: #FF5722; }
        .sidebar.collapsed .sidebar-toggle { order: 1; }
        .sidebar.collapsed .sidebar-logo { order: 2; writing-mode: vertical-rl; text-orientation: mixed; }
        .sidebar-logo { font-size: 20px; font-weight: 300; letter-spacing: 6px; text-transform: uppercase; }
        .sidebar-nav { flex: 1; padding: 24px 16px; overflow-y: auto; }
        .nav-section { margin-bottom: 32px; }
        .nav-label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: #999; letter-spacing: 1px; padding: 0 12px; margin-bottom: 12px; display: block; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; font-size: 14px; color: #666; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; }
        .nav-item i { width: 20px; text-align: center; font-size: 16px; }
        .nav-item:hover { background: #f5f5f5; color: #1a1a1a; }
        .nav-item.active { background: #1a1a1a; color: white; }
        .nav-item.active i { color: #FF5722; }
        .sidebar-footer { padding: 24px; border-top: 1px solid #e8e8e8; }
        .user-info { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; }
        .user-details { flex: 1; overflow: hidden; }
        .user-email { font-size: 13px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .btn-logout { width: 100%; padding: 10px; background: #f5f5f5; border: none; border-radius: 8px; font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .btn-logout:hover { background: #FF5722; color: white; }
        .main-content { flex: 1; margin-left: 280px; transition: margin-left 0.3s ease; }
        .sidebar.collapsed ~ .main-content { margin-left: 80px; }
        .top-bar { background: #f5f5f5; padding: 12px 32px; display: flex; align-items: center; justify-content: space-between; font-size: 13px; color: #666; border-bottom: 1px solid #e8e8e8; }
        .hero { margin: 32px; background: #1a1a1a; border-radius: 24px; padding: 80px 60px; color: white; position: relative; }
        .hero-tag { display: inline-flex; align-items: center; gap: 8px; font-size: 12px; margin-bottom: 40px; opacity: 0.7; }
        .hero-tag::before { content: ''; width: 6px; height: 6px; background: white; border-radius: 50%; }
        .hero-subtitle { font-size: 14px; opacity: 0.7; margin-bottom: 40px; }
        .hero-title { font-size: 72px; font-weight: 300; margin-bottom: 24px; line-height: 1.1; }
        .hero-description { font-size: 16px; line-height: 1.8; max-width: 600px; opacity: 0.9; }
        .container { padding: 0 32px 80px; }
        .section-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 60px; }
        .section-title { font-size: 48px; font-weight: 300; display: flex; align-items: center; gap: 16px; }
        .section-count { width: 32px; height: 32px; background: #1a1a1a; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 500; }
        .section-description { max-width: 500px; font-size: 15px; color: #666; line-height: 1.8; }
        .generator-form { background: white; border-radius: 20px; padding: 48px; margin-bottom: 60px; }
        .form-label { font-size: 14px; font-weight: 500; margin-bottom: 12px; display: block; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 16px; border: 1px solid #e8e8e8; border-radius: 12px; font-size: 15px; font-family: inherit; margin-bottom: 24px; background: white; transition: all 0.2s; }
        .form-select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; padding-right: 40px; }
        .form-textarea { min-height: 120px; resize: vertical; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: #1a1a1a; }
        .templates { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 32px; }
        .template-btn { padding: 16px; background: #f5f5f5; border: none; border-radius: 12px; font-size: 13px; cursor: pointer; transition: all 0.2s; text-align: left; display: flex; align-items: center; gap: 10px; }
        .template-btn:hover { background: #e8e8e8; }
        .template-btn i { color: #FF5722; }
        .btn-generate { width: 100%; padding: 16px; background: #1a1a1a; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-generate:hover { background: #FF5722; transform: translateY(-2px); }
        .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        /* Project Groups */
        .project-group { margin-bottom: 48px; }
        .project-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e8e8e8; }
        .project-name { font-size: 24px; font-weight: 500; text-transform: capitalize; }
        .project-badge { padding: 6px 12px; background: #FF5722; color: white; border-radius: 6px; font-size: 12px; font-weight: 600; }
        
        /* Endpoints Grid */
        .endpoints-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .endpoint-card { background: #e8e8e8; border-radius: 20px; padding: 48px; cursor: pointer; transition: all 0.3s; position: relative; }
        .endpoint-card:hover { background: #dcdcdc; transform: translateY(-4px); }
        .endpoint-card-arrow { position: absolute; bottom: 32px; right: 32px; width: 40px; height: 40px; background: #1a1a1a; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .endpoint-card:hover .endpoint-card-arrow { background: #FF5722; }
        .endpoint-card-arrow i { color: white; font-size: 16px; }
        .endpoint-method { padding: 6px 12px; background: #bbb; border-radius: 8px; font-size: 11px; font-weight: 600; color: #1a1a1a; text-transform: uppercase; display: inline-block; margin-bottom: 24px; }
        .endpoint-path { font-size: 18px; font-weight: 500; margin-bottom: 12px; font-family: 'Monaco', monospace; }
        .endpoint-description { font-size: 14px; color: #666; line-height: 1.7; margin-bottom: 32px; }
        .endpoint-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn-action { padding: 8px 16px; background: #fff; border: 1px solid #e8e8e8; border-radius: 8px; font-size: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .btn-action:hover { border-color: #1a1a1a; }
        .btn-publish { background: #10B981; color: white; border-color: #10B981; }
        .btn-publish:hover { background: #059669; }
        .btn-unpublish { background: #EF4444; color: white; border-color: #EF4444; }
        .btn-unpublish:hover { background: #DC2626; }
        .btn-manage { background: #FF5722; color: white; border-color: #FF5722; }
        .btn-manage:hover { background: #F4511E; }
        .stats-box { position: fixed; bottom: 40px; right: 40px; background: white; border-radius: 16px; padding: 24px 32px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 100; }
        .stats-number { font-size: 32px; font-weight: 300; display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .stats-dot { width: 8px; height: 8px; background: #FF5722; border-radius: 50%; }
        .stats-label { font-size: 13px; color: #666; }
        .alert { background: #e8e8e8; border-radius: 12px; padding: 20px; margin-bottom: 24px; font-size: 14px; }
        .alert-success { background: #ECFDF5; color: #065F46; }
        .alert-error { background: #FEE2E2; color: #991B1B; }
        .empty-state { text-align: center; padding: 80px 20px; }
        .empty-title { font-size: 32px; font-weight: 300; margin-bottom: 16px; }
        .empty-description { font-size: 16px; color: #666; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; border-radius: 20px; width: 90%; max-width: 1200px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 32px; border-bottom: 1px solid #e8e8e8; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 24px; font-weight: 300; }
        .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; }
        .btn-close:hover { background: #e8e8e8; }
        .modal-body { flex: 1; overflow-y: auto; padding: 0; }
        .table-toolbar { padding: 24px 32px; border-bottom: 1px solid #e8e8e8; display: flex; justify-content: space-between; align-items: center; }
        .btn-add { padding: 12px 24px; background: #1a1a1a; color: white; border: none; border-radius: 10px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-add:hover { background: #FF5722; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #f5f5f5; padding: 16px 32px; text-align: left; font-size: 12px; font-weight: 500; text-transform: uppercase; color: #666; }
        .data-table td { padding: 20px 32px; border-top: 1px solid #e8e8e8; font-size: 14px; }
        .data-table tr:hover { background: #fafafa; }
        .form-group { margin-bottom: 24px; }
        .modal-footer { padding: 24px 32px; border-top: 1px solid #e8e8e8; display: flex; justify-content: flex-end; gap: 12px; }
        .btn-cancel { padding: 12px 24px; background: #e8e8e8; border: none; border-radius: 10px; font-size: 14px; cursor: pointer; }
        .btn-cancel:hover { background: #dcdcdc; }
        .btn-save { padding: 12px 24px; background: #1a1a1a; color: white; border: none; border-radius: 10px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-save:hover { background: #FF5722; }
        .btn-delete { padding: 8px 12px; background: #EF4444; color: white; border: none; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .btn-delete:hover { background: #DC2626; }
        .btn-edit { padding: 8px 12px; background: #e8e8e8; border: none; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .btn-edit:hover { background: #dcdcdc; }
        .edit-tab.active { color: #FF5722 !important; border-bottom-color: #FF5722 !important; }
        .edit-tab:hover { color: #1a1a1a !important; }
        .edit-tab-panel { display: none; }
        .edit-tab-panel.active { display: block !important; }
        .btn-primary { padding: 12px 24px; background: #1a1a1a; color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary:hover { background: #FF5722; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { padding: 12px 24px; background: #EF4444; color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-danger:hover { background: #DC2626; }
        .btn-secondary { padding: 12px 24px; background: #e8e8e8; color: #1a1a1a; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-secondary:hover { background: #dcdcdc; }
        .crud-item { background: #f5f5f5; border-radius: 12px; padding: 20px; }
        .crud-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .method-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .method-get { background: #ECFDF5; color: #059669; }
        .method-post { background: #EFF6FF; color: #2563EB; }
        .method-put { background: #FEF3C7; color: #D97706; }
        .method-delete { background: #FEE2E2; color: #DC2626; }
        .crud-path { font-family: 'Monaco', monospace; font-size: 14px; font-weight: 500; }
        .crud-description { font-size: 14px; color: #666; }
        .stat-card { background: white; border-radius: 16px; padding: 24px; }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; font-size: 20px; }
        .stat-value { font-size: 32px; font-weight: 300; margin-bottom: 4px; }
        .stat-label { font-size: 13px; color: #666; }
        .method-tab.active { color: #FF5722 !important; border-bottom-color: #FF5722 !important; background: #FFF3E0 !important; }
        .method-tab:hover { color: #1a1a1a !important; background: #fafafa !important; }
        .method-panel { display: none; }
        .method-panel.active { display: block !important; }
        .drop-zone { border: 2px dashed #e8e8e8; border-radius: 16px; padding: 60px 40px; text-align: center; cursor: pointer; transition: all 0.3s; background: #fafafa; }
        .drop-zone:hover { border-color: #FF5722; background: #fff; }
        .drop-zone.dragging { border-color: #FF5722; background: #FFF3E0; }
        .drop-zone-content { pointer-events: none; }
        .dataset-card { background: white; border-radius: 16px; padding: 24px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .dataset-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .dataset-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .dataset-icon { width: 48px; height: 48px; background: #FFF3E0; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #FF5722; font-size: 20px; }
        .dataset-badge { padding: 4px 8px; background: #f5f5f5; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; color: #666; }
        .dataset-title { font-size: 18px; font-weight: 500; margin-bottom: 8px; }
        .dataset-description { font-size: 13px; color: #666; margin-bottom: 16px; line-height: 1.5; }
        .dataset-meta { display: flex; gap: 16px; margin-bottom: 16px; font-size: 12px; color: #999; }
        .dataset-meta-item { display: flex; align-items: center; gap: 6px; }
        .dataset-actions { display: flex; gap: 8px; }
    </style>
</head>
<body>
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <div class="auth-logo">KEBAPI</div>
            <h1 class="auth-title">Welcome back</h1>
            <p class="auth-subtitle">Sign in to continue to your dashboard</p>
            <button onclick="signInWithGoogle()" class="btn-google">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <div id="loadingScreen" class="loading-screen hidden">
        <div class="spinner"></div>
        <p style="color: #666;">Loading...</p>
    </div>

    <div id="mainApp" class="hidden">
        <div class="app-container">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-logo">KEBAPI</div>
                    <button class="sidebar-toggle" onclick="toggleSidebar()" style="background: none; border: none; cursor: pointer; color: #666; font-size: 18px; padding: 8px;">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-section">
                        <span class="nav-label">Main</span>
                        <div class="nav-item active" onclick="showSection('generator')">
                            <i class="fas fa-wand-magic-sparkles"></i>
                            <span>Generator</span>
                        </div>
                        <div class="nav-item" onclick="showSection('endpoints')">
                            <i class="fas fa-database"></i>
                            <span>My APIs</span>
                        </div>
                        <div class="nav-item" onclick="showSection('knowledgebase')">
                            <i class="fas fa-layer-group"></i>
                            <span>Knowledge Base</span>
                        </div>
                        <div class="nav-item" onclick="showSection('analytics')">
                            <i class="fas fa-chart-line"></i>
                            <span>Analytics</span>
                        </div>
                    </div>
                    <div class="nav-section">
                        <span class="nav-label">Discover</span>
                        <a href="/marketplace.html" class="nav-item">
                            <i class="fas fa-globe"></i>
                            <span>Marketplace</span>
                        </a>
                    </div>
                </nav>
                <div class="sidebar-footer">
                    <div class="user-info">
                        <img id="userAvatar" class="user-avatar" src="" alt="User">
                        <div class="user-details">
                            <div id="userEmail" class="user-email"></div>
                        </div>
                    </div>
                    <button onclick="signOut()" class="btn-logout">
                        <i class="fas fa-sign-out-alt"></i> Sign Out
                    </button>
                </div>
            </aside>

            <main class="main-content">
                <div class="top-bar">
                    <span id="breadcrumb">Dashboard</span>
                    <span style="font-size: 12px; color: #999;">EN</span>
                </div>

                <div id="generatorSection">
                    <section class="hero">
                        <div class="hero-tag">AI-Powered</div>
                        <div class="hero-subtitle">Generate REST APIs instantly</div>
                        <h1 class="hero-title">Create APIs</h1>
                        <p class="hero-description">Describe your API in natural language and let AI generate fully functional REST endpoints with CRUD operations.</p>
                    </section>

                    <div class="container">
                        <!-- Method Selector Tabs -->
                        <div style="background: white; border-radius: 20px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; border-bottom: 1px solid #e8e8e8;">
                                <button class="method-tab active" onclick="switchMethodTab('ai')" style="flex: 1; padding: 20px 32px; background: none; border: none; font-size: 15px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                                    <i class="fas fa-wand-magic-sparkles"></i> Generate with AI
                                </button>
                                <button class="method-tab" onclick="switchMethodTab('upload')" style="flex: 1; padding: 20px 32px; background: none; border: none; font-size: 15px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                                    <i class="fas fa-upload"></i> Upload Dataset
                                </button>
                            </div>

                            <!-- AI Generator Form -->
                            <div id="aiGeneratorForm" class="method-panel active" style="padding: 40px;">
                            <label class="form-label">Project Name</label>
                            <input id="projectInput" class="form-input" placeholder="e.g., entertainment, ecommerce, social..." value="">
                            
                            <label class="form-label">Describe your API</label>
                            <textarea id="promptInput" class="form-textarea" placeholder="Example: Create an API for restaurants with name, cuisine type, address and rating..."></textarea>

                            <div class="templates">
                                <button class="template-btn" onclick="setPrompt('entertainment', 'endpoint de restaurantes con nombre, tipo de comida, dirección y calificación')">
                                    <i class="fas fa-utensils"></i> Restaurants
                                </button>
                                <button class="template-btn" onclick="setPrompt('ecommerce', 'API de productos tech con nombre, precio, marca y stock')">
                                    <i class="fas fa-laptop"></i> Tech Products
                                </button>
                                <button class="template-btn" onclick="setPrompt('social', 'endpoint de usuarios con nombre, email, edad y ciudad')">
                                    <i class="fas fa-users"></i> Users
                                </button>
                                <button class="template-btn" onclick="setPrompt('productivity', 'API de tareas con título, descripción, prioridad y estado')">
                                    <i class="fas fa-list-check"></i> Tasks
                                </button>
                            </div>

                            <button class="btn-generate" id="generateBtn" onclick="generarEndpoint()">
                                <i class="fas fa-wand-magic-sparkles"></i>Generate API
                            </button>

                            <div id="loading" class="loading hidden" style="text-align: center; padding: 40px;">
                                <div class="spinner" style="margin: 0 auto 16px;"></div>
                                <p style="color: #666;">Generating...</p>
                            </div>
                            <div id="result" class="hidden"></div>
                            <div id="error" class="hidden"></div>
                            </div>

                            <!-- Upload Dataset Form -->
                            <div id="uploadGeneratorForm" class="method-panel hidden" style="padding: 40px;">
                            <label class="form-label">Project Name</label>
                            <input id="uploadProjectInput" class="form-input" placeholder="e.g., data, research, public..." value="">
                            
                            <label class="form-label">API Name</label>
                            <input id="uploadApiNameInput" class="form-input" placeholder="e.g., world-cities, covid-data..." value="">

                            <label class="form-label">Upload Your Dataset</label>
                            <div id="dropZone" class="drop-zone">
                                <input type="file" id="fileInput" accept=".csv,.json,.xlsx" style="display: none;" onchange="handleFileSelect(event)">
                                <div class="drop-zone-content" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #FF5722; margin-bottom: 16px;"></i>
                                    <p style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">Drop your file here or click to browse</p>
                                    <p style="font-size: 13px; color: #666;">Supports CSV, JSON, Excel (max 10MB, 50K rows)</p>
                                </div>
                            </div>

                            <div id="filePreview" class="hidden" style="margin-top: 24px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <div>
                                        <p style="font-weight: 500; margin-bottom: 4px;"><i class="fas fa-file"></i> <span id="fileName"></span></p>
                                        <p style="font-size: 13px; color: #666;"><span id="fileStats"></span></p>
                                    </div>
                                    <button onclick="clearFile()" style="padding: 8px 16px; background: #e8e8e8; border: none; border-radius: 8px; cursor: pointer;">
                                        <i class="fas fa-times"></i> Remove
                                    </button>
                                </div>

                                <div style="background: #f5f5f5; border-radius: 12px; padding: 16px; max-height: 300px; overflow: auto;">
                                    <p style="font-size: 13px; font-weight: 600; margin-bottom: 12px; color: #666;">PREVIEW (first 5 rows)</p>
                                    <div id="previewTable"></div>
                                </div>

                                <div style="margin-top: 24px;">
                                    <p style="font-size: 14px; font-weight: 500; margin-bottom: 12px;">Detected Schema:</p>
                                    <div id="schemaPreview" style="background: #f5f5f5; border-radius: 12px; padding: 16px; font-family: Monaco, monospace; font-size: 13px;"></div>
                                </div>
                            </div>

                            <button class="btn-generate" id="uploadBtn" onclick="generateFromDataset()" disabled style="margin-top: 24px;">
                                <i class="fas fa-database"></i> Generate API from Dataset
                            </button>

                            <div id="uploadLoading" class="loading hidden" style="text-align: center; padding: 40px;">
                                <div class="spinner" style="margin: 0 auto 16px;"></div>
                                <p style="color: #666;">Processing dataset...</p>
                            </div>
                            <div id="uploadResult" class="hidden"></div>
                            <div id="uploadError" class="hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="endpointsSection" class="hidden">
                    <section class="hero">
                        <div class="hero-tag">Dashboard</div>
                        <div class="hero-subtitle">Manage your APIs</div>
                        <h1 class="hero-title">My APIs</h1>
                        <p class="hero-description">View, manage and publish your generated API endpoints to the public marketplace.</p>
                    </section>

                    <div class="container">
                        <div class="section-header">
                            <h2 class="section-title">APIs<span class="section-count" id="apiCount">0</span></h2>
                            <p class="section-description">All your generated endpoints grouped by project with full CRUD operations.</p>
                        </div>

                        <div id="endpointsList"></div>
                        <div id="noEndpoints" class="empty-state">
                            <h3 class="empty-title">No APIs yet</h3>
                            <p class="empty-description">Create your first API using the generator</p>
                        </div>
                    </div>
                </div>

                <!-- Edit API Section -->
                <div id="editSection" class="hidden">
                    <section class="hero">
                        <div class="hero-tag" id="editProjectBadge">Project</div>
                        <div class="hero-subtitle">Edit API</div>
                        <h1 class="hero-title" id="editApiName">API Name</h1>
                        <p class="hero-description" id="editApiDescription">Description</p>
                        <div class="api-url-box" style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; display: flex; align-items: center; justify-content: space-between; margin-top: 24px;">
                            <code class="api-url" id="editApiUrl" style="font-family: 'Monaco', monospace; font-size: 16px; color: #FF5722;">https://...</code>
                            <button class="btn-copy" onclick="copyEditUrl(event)" style="padding: 10px 20px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.2s;">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </section>

                    <div class="container">
                        <div id="editAlertContainer"></div>

                        <!-- Tabs for Edit -->
                        <div style="background: white; border-radius: 12px 12px 0 0; display: flex; border-bottom: 1px solid #e8e8e8; margin-bottom: 0;">
                            <button class="edit-tab active" onclick="switchEditTab('details')" style="padding: 16px 32px; background: none; border: none; font-size: 15px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;">
                                <i class="fas fa-edit"></i> Details
                            </button>
                            <button class="edit-tab" onclick="switchEditTab('data')" id="dataTabBtn" style="padding: 16px 32px; background: none; border: none; font-size: 15px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;">
                                <i class="fas fa-database"></i> Data
                            </button>
                            <button class="edit-tab" onclick="switchEditTab('reference')" style="padding: 16px 32px; background: none; border: none; font-size: 15px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;">
                                <i class="fas fa-code"></i> API Reference
                            </button>
                            <button class="edit-tab" onclick="switchEditTab('docs')" style="padding: 16px 32px; background: none; border: none; font-size: 15px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;">
                                <i class="fas fa-book"></i> Documentation
                            </button>
                        </div>

                        <!-- Tab Panels -->
                        <div style="background: white; border-radius: 0 0 12px 12px; padding: 48px; margin-bottom: 24px;">
                            <!-- Details Tab -->
                            <div id="editTab-details" class="edit-tab-panel active">
                                <div class="form-group">
                                    <label class="form-label">Project Name</label>
                                    <input type="text" id="editProjectInput" class="form-input" placeholder="e.g., entertainment">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Endpoint Name</label>
                                    <input type="text" id="editEndpointInput" class="form-input" placeholder="e.g., movies">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <textarea id="editDescriptionInput" class="form-textarea" placeholder="Brief description of your API"></textarea>
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <button class="btn-primary" onclick="saveEditChanges()">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <button class="btn-secondary" onclick="closeEditSection()">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>

                            <!-- Data Tab -->
                            <div id="editTab-data" class="edit-tab-panel hidden">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                    <div>
                                        <h3 style="font-size: 20px; font-weight: 500; margin-bottom: 4px;">Manage Data</h3>
                                        <p style="font-size: 14px; color: #666;" id="editDataCount">0 items</p>
                                    </div>
                                    <button class="btn-add" onclick="openCreateItemInlineModal()">
                                        <i class="fas fa-plus"></i> Add New
                                    </button>
                                </div>
                                <div id="editDataTableWrapper">
                                    <table class="data-table" id="editDataTable">
                                        <thead id="editDataTableHead"></thead>
                                        <tbody id="editDataTableBody"></tbody>
                                    </table>
                                </div>
                                <div id="editDataEmpty" class="empty-state hidden">
                                    <h3 class="empty-title">No data yet</h3>
                                    <p class="empty-description">Click "Add New" to create your first item</p>
                                </div>
                            </div>

                            <!-- API Reference Tab -->
                            <div id="editTab-reference" class="edit-tab-panel hidden">
                                <div style="margin-bottom: 32px;">
                                    <h3 style="font-size: 20px; font-weight: 500; margin-bottom: 8px;">API Endpoints</h3>
                                    <p style="font-size: 14px; color: #666;">Complete reference of available CRUD operations for this API.</p>
                                </div>
                                
                                <div id="editApiReference" style="display: flex; flex-direction: column; gap: 16px;"></div>
                                
                                <div style="margin-top: 32px; padding: 24px; background: #f5f5f5; border-radius: 12px;">
                                    <h4 style="font-size: 16px; font-weight: 500; margin-bottom: 12px;">Base URL</h4>
                                    <code id="editBaseUrl" style="font-family: 'Monaco', monospace; font-size: 14px; color: #FF5722;"></code>
                                </div>
                            </div>

                            <!-- Documentation Tab -->
                            <div id="editTab-docs" class="edit-tab-panel hidden">
                                <div style="margin-bottom: 24px;">
                                    <h3 style="font-size: 20px; font-weight: 500; margin-bottom: 8px;">API Documentation</h3>
                                    <p style="font-size: 14px; color: #666;">Write custom documentation for your API. Supports Markdown.</p>
                                </div>
                                <div class="form-group">
                                    <textarea id="editDocsInput" class="form-textarea" placeholder="# My API Documentation

## Overview
Describe what your API does...

## Authentication
Explain how to authenticate...

## Examples
Provide usage examples..." style="min-height: 400px; font-family: 'Monaco', monospace;"></textarea>
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <button class="btn-primary" onclick="saveDocumentation()">
                                        <i class="fas fa-save"></i> Save Documentation
                                    </button>
                                    <button class="btn-secondary" onclick="generateDocumentation()">
                                        <i class="fas fa-wand-magic-sparkles"></i> Generate with AI
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Danger Zone -->
                        <div style="background: white; border: 2px solid #FEE2E2; border-radius: 12px; padding: 32px;">
                            <h3 style="font-size: 20px; font-weight: 500; color: #EF4444; margin-bottom: 8px;">
                                <i class="fas fa-exclamation-triangle"></i> Danger Zone
                            </h3>
                            <p style="color: #666; margin-bottom: 24px;">Once you delete an API, there is no going back. Please be certain.</p>
                            <button class="btn-danger" onclick="deleteEditAPI()">
                                <i class="fas fa-trash"></i> Delete This API
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div id="analyticsSection" class="hidden">
                    <section class="hero">
                        <div class="hero-tag">Dashboard</div>
                        <div class="hero-subtitle">Track your APIs</div>
                        <h1 class="hero-title">Analytics</h1>
                        <p class="hero-description">Monitor requests, response times, and usage patterns across all your APIs.</p>
                    </section>

                    <div class="container">
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 48px;">
                            <div class="stat-card">
                                <div class="stat-icon" style="background: #EFF6FF;"><i class="fas fa-server" style="color: #2563EB;"></i></div>
                                <div class="stat-value" id="totalRequests">0</div>
                                <div class="stat-label">Total Requests</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: #ECFDF5;"><i class="fas fa-clock" style="color: #059669;"></i></div>
                                <div class="stat-value" id="requests24h">0</div>
                                <div class="stat-label">Last 24 Hours</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: #FEF3C7;"><i class="fas fa-calendar-week" style="color: #D97706;"></i></div>
                                <div class="stat-value" id="requests7d">0</div>
                                <div class="stat-label">Last 7 Days</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: #FEE2E2;"><i class="fas fa-calendar-alt" style="color: #DC2626;"></i></div>
                                <div class="stat-value" id="requests30d">0</div>
                                <div class="stat-label">Last 30 Days</div>
                            </div>
                        </div>

                        <!-- API Selector & Chart -->
                        <div style="background: white; border-radius: 20px; padding: 40px; margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                                <h2 style="font-size: 24px; font-weight: 500;">Requests Over Time</h2>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <select id="analyticsApiSelect" class="form-select" style="width: 300px;" onchange="loadEndpointAnalytics()">
                                        <option value="">All APIs</option>
                                    </select>
                                    <select id="analyticsRangeSelect" class="form-select" style="width: 150px;" onchange="loadEndpointAnalytics()">
                                        <option value="24h">Last 24h</option>
                                        <option value="7d" selected>Last 7 days</option>
                                        <option value="30d">Last 30 days</option>
                                    </select>
                                </div>
                            </div>
                            <canvas id="requestsChart" style="max-height: 300px;"></canvas>
                        </div>

                        <!-- APIs Table -->
                        <div style="background: white; border-radius: 20px; padding: 40px;">
                            <h2 style="font-size: 24px; font-weight: 500; margin-bottom: 24px;">APIs Performance</h2>
                            <table class="data-table" id="analyticsTable">
                                <thead>
                                    <tr>
                                        <th>API</th>
                                        <th>Project</th>
                                        <th>Requests</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="analyticsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="stats-box">
                    <div class="stats-number">
                        <span class="stats-dot"></span>
                        <span id="statsNumber">0</span>
                    </div>
                    <div class="stats-label">APIs created</div>
                </div>

                <!-- Knowledge Base Section -->
                <div id="knowledgebaseSection" class="hidden">
                    <section class="hero">
                        <div class="hero-tag">Data Management</div>
                        <div class="hero-subtitle">Your datasets & data sources</div>
                        <h1 class="hero-title">Knowledge Base</h1>
                        <p class="hero-description">Manage your datasets, create multiple APIs from the same data source, and keep everything synchronized.</p>
                    </section>

                    <div class="container">
                        <!-- Header with actions -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                            <div>
                                <h2 style="font-size: 24px; font-weight: 500; margin-bottom: 8px;">My Datasets</h2>
                                <p style="font-size: 14px; color: #666;">Upload and manage data sources that can be used by multiple APIs</p>
                            </div>
                            <button class="btn-primary" onclick="showUploadDatasetModal()">
                                <i class="fas fa-upload"></i> Upload Dataset
                            </button>
                        </div>

                        <!-- Datasets Grid -->
                        <div id="datasetsGrid" class="hidden" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 24px;"></div>

                        <!-- Loading -->
                        <div id="datasetsLoading" class="loading hidden">
                            <div class="spinner"></div>
                            <p style="color: #666;">Loading datasets...</p>
                        </div>

                        <!-- Empty State -->
                        <div id="datasetsEmpty" class="empty-state hidden">
                            <h3 class="empty-title">No datasets yet</h3>
                            <p class="empty-description">Upload your first dataset to get started</p>
                            <button class="btn-primary" onclick="showUploadDatasetModal()" style="margin-top: 24px;">
                                <i class="fas fa-upload"></i> Upload Dataset
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="dataManagerModal" class="modal-overlay hidden" onclick="closeDataManagerOnOverlay(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <h3 id="dataManagerTitle" class="modal-title">Manage Data</h3>
                    <p id="dataManagerSubtitle" style="font-size: 14px; color: #666; margin-top: 4px;"></p>
                </div>
                <button onclick="closeDataManager()" class="btn-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="table-toolbar">
                    <div id="dataCount" style="font-size: 14px; color: #666;"></div>
                    <button onclick="openCreateItemModal()" class="btn-add"><i class="fas fa-plus"></i>Add New</button>
                </div>
                <div id="dataTableLoading" class="loading hidden" style="padding: 60px;"><div class="spinner" style="margin: 0 auto 16px;"></div><p style="color: #666;">Loading...</p></div>
                <div id="dataTableWrapper"><table id="dataManagerTable" class="data-table"><thead id="dataManagerTableHead"></thead><tbody id="dataManagerTableBody"></tbody></table></div>
                <div id="dataManagerEmpty" class="empty-state hidden"><h3 class="empty-title">No data yet</h3><p class="empty-description">Click "Add New" to create your first item</p></div>
            </div>
        </div>
    </div>

    <div id="itemModal" class="modal-overlay hidden" onclick="closeItemModalOnOverlay(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="itemModalTitle" class="modal-title">Add New Item</h3>
                <button onclick="closeItemModal()" class="btn-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 32px;">
                <form id="itemForm"></form>
            </div>
            <div class="modal-footer">
                <button onclick="closeItemModal()" class="btn-cancel">Cancel</button>
                <button onclick="saveItem()" class="btn-save"><i class="fas fa-save"></i>Save</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin.replace('http://', 'https://');
        const SUPABASE_URL = 'https://nugcshddtrufgciosrsq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51Z2NzaGRkdHJ1ZmdjaW9zcnNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTUyMTMsImV4cCI6MjA4MTIzMTIxM30.1ECmZ8bG8HasOZ6pH_b3atPg6i9dxTRcPPUXehbiixY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;
        let endpoints = new Map();
        let currentDataEndpoint = null;
        let currentDataItems = [];
        let editingItemId = null;

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) { currentUser = session.user; showApp(); } else { showAuth(); }
            supabase.auth.onAuthStateChange((event, session) => {
                if (session) { currentUser = session.user; showApp(); } else { showAuth(); }
            });
        }

        function showAuth() { document.getElementById('authScreen').classList.remove('hidden'); document.getElementById('loadingScreen').classList.add('hidden'); document.getElementById('mainApp').classList.add('hidden'); }
        function showApp() { 
            document.getElementById('authScreen').classList.add('hidden'); 
            document.getElementById('loadingScreen').classList.add('hidden'); 
            document.getElementById('mainApp').classList.remove('hidden'); 
            document.getElementById('userEmail').textContent = currentUser.email; 
            document.getElementById('userAvatar').src = currentUser.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.email)}&background=FF5722&color=fff`; 
            restoreSidebarState(); 
            initDropZone(); // Inicializar drag & drop
            cargarEndpoints(); 
        }
        async function signInWithGoogle() { const { error } = await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin } }); if (error) { alert('Error: ' + error.message); } }
        async function signOut() { const { error } = await supabase.auth.signOut(); if (error) { alert('Error: ' + error.message); } }
        
        function showSection(section) {
            document.getElementById('generatorSection').classList.add('hidden');
            document.getElementById('endpointsSection').classList.add('hidden');
            document.getElementById('editSection').classList.add('hidden');
            document.getElementById('analyticsSection').classList.add('hidden');
            document.getElementById('knowledgebaseSection').classList.add('hidden');
            document.getElementById(section + 'Section').classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => { item.classList.remove('active'); });
            event.target.classList.add('active');
            
            if (section === 'generator') {
                document.getElementById('breadcrumb').textContent = 'Generator';
            } else if (section === 'endpoints') {
                document.getElementById('breadcrumb').textContent = 'My APIs';
                cargarEndpoints();
                currentEditAPI = null;
            } else if (section === 'analytics') {
                document.getElementById('breadcrumb').textContent = 'Analytics';
                loadAnalytics();
            } else if (section === 'knowledgebase') {
                document.getElementById('breadcrumb').textContent = 'Knowledge Base';
                loadDatasets();
            }
            
            window.scrollTo(0, 0);
        }

        function setPrompt(project, text) { 
            document.getElementById('projectInput').value = project; 
            document.getElementById('promptInput').value = text; 
        }
        
        async function generarEndpoint() {
            const prompt = document.getElementById('promptInput').value;
            const project_name = document.getElementById('projectInput').value.trim() || 'default';
            const loading = document.getElementById('loading'); const result = document.getElementById('result'); const error = document.getElementById('error'); const btn = document.getElementById('generateBtn');
            if (prompt.length < 10) { error.innerHTML = '<div class="alert alert-error">Prompt must be at least 10 characters</div>'; error.classList.remove('hidden'); result.classList.add('hidden'); return; }
            loading.classList.remove('hidden'); result.classList.add('hidden'); error.classList.add('hidden'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Generating...';
            try {
                const { data: { session } } = await supabase.auth.getSession();
                const response = await fetch(`${API_URL}/api/create-endpoint`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` }, body: JSON.stringify({ prompt, project_name }) });
                const data = await response.json();
                if (!response.ok) { throw new Error(data.error || 'Error generating endpoint'); }
                loading.classList.add('hidden'); result.classList.remove('hidden');
                const fullUrl = `${API_URL}/api/${data.endpoint.project_name}${data.endpoint.path}`;
                result.innerHTML = `<div class="alert alert-success"><strong>✓ API created successfully!</strong><br><br><code style="color: #065F46; font-weight: 500;">${fullUrl}</code></div>`;
                document.getElementById('promptInput').value = ''; document.getElementById('projectInput').value = ''; await cargarEndpoints();
            } catch (err) { loading.classList.add('hidden'); error.innerHTML = `<div class="alert alert-error">${err.message}</div>`; error.classList.remove('hidden'); } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i>Generate API'; }
        }

        async function cargarEndpoints() {
            try {
                const { data, error } = await supabase.from('endpoints').select('*').order('project_name', { ascending: true }).order('createdAt', { ascending: false });
                const list = document.getElementById('endpointsList'); const noEndpoints = document.getElementById('noEndpoints'); const apiCount = document.getElementById('apiCount'); const statsNumber = document.getElementById('statsNumber');
                if (error) throw error;
                if (data && data.length > 0) {
                    noEndpoints.classList.add('hidden'); apiCount.textContent = data.length; statsNumber.textContent = data.length;
                    endpoints.clear(); data.forEach(ep => endpoints.set(ep.id, ep));
                    
                    // Agrupar por proyecto
                    const grouped = data.reduce((acc, ep) => {
                        const project = ep.project_name || 'default';
                        if (!acc[project]) acc[project] = [];
                        acc[project].push(ep);
                        return acc;
                    }, {});
                    
                    list.innerHTML = Object.entries(grouped).map(([project, eps]) => `
                        <div class="project-group">
                            <div class="project-header">
                                <h3 class="project-name">${project}</h3>
                                <span class="project-badge">${eps.length} ${eps.length === 1 ? 'API' : 'APIs'}</span>
                            </div>
                            <div class="endpoints-grid">
                                ${eps.map(ep => {
                                    const fullUrl = `${API_URL}/api/${ep.project_name}${ep.path}`;
                                    const publishBtn = ep.published ? `<button class="btn-action btn-unpublish" onclick="togglePublish('${ep.id}', false)"><i class="fas fa-eye-slash"></i> Unpublish</button>` : `<button class="btn-action btn-publish" onclick="togglePublish('${ep.id}', true)"><i class="fas fa-globe"></i> Publish</button>`;
                                    return `
                                        <div class="endpoint-card" onclick="openEditAPI('${ep.id}')">
                                            <div class="endpoint-method">${ep.method}</div>
                                            <div class="endpoint-path">${ep.path}</div>
                                            <div class="endpoint-description">${ep.description}</div>
                                            <div class="endpoint-actions" onclick="event.stopPropagation()">
                                                ${publishBtn}
                                            </div>
                                            <div class="endpoint-card-arrow">
                                                <i class="fas fa-arrow-right"></i>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('');
                } else { noEndpoints.classList.remove('hidden'); apiCount.textContent = '0'; statsNumber.textContent = '0'; list.innerHTML = ''; }
            } catch (err) { console.error('Error loading endpoints:', err); }
        }

        async function togglePublish(endpointId, publish) { if (!confirm(publish ? 'Publish to marketplace?' : 'Unpublish from marketplace?')) { return; } try { const { error } = await supabase.from('endpoints').update({ published: publish }).eq('id', endpointId); if (error) { alert('Error: ' + error.message); return; } await cargarEndpoints(); } catch (err) { alert('Error: ' + err.message); } }
        async function openDataManager(endpointId) { const endpoint = endpoints.get(endpointId); if (!endpoint || !endpoint.schema) return; currentDataEndpoint = endpoint; document.getElementById('dataManagerTitle').textContent = 'Manage Data'; document.getElementById('dataManagerSubtitle').textContent = endpoint.description; document.getElementById('dataManagerModal').classList.remove('hidden'); loadDataItems(); }
        async function loadDataItems() { const loading = document.getElementById('dataTableLoading'); const wrapper = document.getElementById('dataTableWrapper'); const empty = document.getElementById('dataManagerEmpty'); loading.classList.remove('hidden'); wrapper.classList.add('hidden'); empty.classList.add('hidden'); const { data, error } = await supabase.from('endpoint_items').select('*').eq('endpoint_id', currentDataEndpoint.id).order('created_at', { ascending: false }); loading.classList.add('hidden'); if (error) { alert('Error: ' + error.message); return; } currentDataItems = data || []; if (currentDataItems.length === 0) { empty.classList.remove('hidden'); document.getElementById('dataCount').textContent = 'No items'; } else { wrapper.classList.remove('hidden'); document.getElementById('dataCount').textContent = `${currentDataItems.length} item${currentDataItems.length !== 1 ? 's' : ''}`; renderDataTable(); } }
        function renderDataTable() { const thead = document.getElementById('dataManagerTableHead'); const tbody = document.getElementById('dataManagerTableBody'); const fields = currentDataEndpoint.schema?.fields || []; const sampleItem = currentDataItems[0]?.data || {}; const fieldNames = fields.length > 0 ? fields.map(f => f.name) : Object.keys(sampleItem); thead.innerHTML = `<tr>${fieldNames.map(field => `<th>${field}</th>`).join('')}<th style="width: 140px;">Actions</th></tr>`; tbody.innerHTML = currentDataItems.map(item => `<tr>${fieldNames.map(field => { const value = item.data[field]; const displayValue = typeof value === 'object' ? JSON.stringify(value) : (value !== undefined && value !== null ? value : '-'); const truncated = String(displayValue).length > 50 ? String(displayValue).substring(0, 50) + '...' : displayValue; return `<td title="${String(displayValue)}">${truncated}</td>`; }).join('')}<td><div style="display: flex; gap: 8px;"><button onclick="openEditItemModal('${item.id}')" class="btn-edit"><i class="fas fa-edit"></i></button><button onclick="deleteDataItem('${item.id}')" class="btn-delete"><i class="fas fa-trash"></i></button></div></td></tr>`).join(''); }
        function openCreateItemModal() { editingItemId = null; document.getElementById('itemModalTitle').textContent = 'Add New Item'; buildItemForm(); document.getElementById('itemModal').classList.remove('hidden'); }
        function openEditItemModal(itemId) { editingItemId = itemId; document.getElementById('itemModalTitle').textContent = 'Edit Item'; buildItemForm(itemId); document.getElementById('itemModal').classList.remove('hidden'); }
        function buildItemForm(itemId = null) { const form = document.getElementById('itemForm'); const fields = currentDataEndpoint.schema?.fields || []; let itemData = {}; if (itemId) { const item = currentDataItems.find(i => i.id === itemId); itemData = item?.data || {}; } form.innerHTML = fields.map(field => `<div class="form-group"><label class="form-label">${field.name}${field.required ? ' *' : ''}</label><input type="${field.type === 'number' ? 'number' : 'text'}" name="${field.name}" class="form-input" value="${itemData[field.name] || ''}" ${field.required ? 'required' : ''} placeholder="Enter ${field.name}"></div>`).join(''); }
        async function saveItem() { 
            const form = document.getElementById('itemForm'); 
            if (!form.checkValidity()) { form.reportValidity(); return; } 
            const formData = new FormData(form); 
            const data = {}; 
            
            // Usar currentEditAPI si estamos en edición inline, sino currentDataEndpoint
            const activeEndpoint = currentEditAPI || currentDataEndpoint;
            const fields = activeEndpoint.schema?.fields || []; 
            
            for (let [key, value] of formData.entries()) { 
                const field = fields.find(f => f.name === key); 
                if (field && field.type === 'number') { 
                    data[key] = parseFloat(value) || value; 
                } else { 
                    data[key] = value; 
                } 
            } 
            
            if (editingItemId) { 
                const { error } = await supabase.from('endpoint_items').update({ data: data }).eq('id', editingItemId); 
                if (error) { alert('Error: ' + error.message); return; } 
            } else { 
                const { error } = await supabase.from('endpoint_items').insert({ endpoint_id: activeEndpoint.id, user_id: currentUser.id, data: data }); 
                if (error) { alert('Error: ' + error.message); return; } 
            } 
            
            closeItemModal(); 
            
            // Recargar datos apropiados
            if (currentEditAPI) {
                loadEditDataItems();
            } else {
                loadDataItems();
            }
        }
        async function deleteDataItem(itemId) { if (!confirm('Delete this item?')) { return; } const { error } = await supabase.from('endpoint_items').delete().eq('id', itemId); if (error) { alert('Error: ' + error.message); return; } loadDataItems(); }
        function closeDataManager() { document.getElementById('dataManagerModal').classList.add('hidden'); currentDataEndpoint = null; currentDataItems = []; }
        function closeDataManagerOnOverlay(event) { if (event.target === event.currentTarget) { closeDataManager(); } }
        function closeItemModal() { document.getElementById('itemModal').classList.add('hidden'); editingItemId = null; }
        function closeItemModalOnOverlay(event) { if (event.target === event.currentTarget) { closeItemModal(); } }

        // ═══════════════════════════════════════════════════════════
        // EDIT API INLINE FUNCTIONS
        // ═══════════════════════════════════════════════════════════
        let currentEditAPI = null;
        let editDataItems = [];

        function openEditAPI(apiId) {
            const api = endpoints.get(apiId);
            if (!api) return;
            
            currentEditAPI = api;
            
            // Ocultar otras secciones
            document.getElementById('generatorSection').classList.add('hidden');
            document.getElementById('endpointsSection').classList.add('hidden');
            document.getElementById('editSection').classList.remove('hidden');
            
            // Actualizar nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            // Actualizar breadcrumb
            document.getElementById('breadcrumb').textContent = 'Edit API';
            
            // Construir URL completa
            const fullUrl = `${API_URL}/api/${api.project_name}${api.path}`;
            
            // Renderizar datos de la API
            document.getElementById('editProjectBadge').textContent = api.project_name;
            document.getElementById('editApiName').textContent = api.path.replace('/', '').toUpperCase() + ' API';
            document.getElementById('editApiDescription').textContent = api.description;
            document.getElementById('editApiUrl').textContent = fullUrl;
            document.getElementById('editProjectInput').value = api.project_name;
            document.getElementById('editEndpointInput').value = api.path.replace('/', '');
            document.getElementById('editDescriptionInput').value = api.description;
            document.getElementById('editDocsInput').value = api.documentation || '';
            
            // Rellenar API Reference
            if (api.schema) {
                const referenceContainer = document.getElementById('editApiReference');
                const baseUrl = `${API_URL}/api/${api.project_name}${api.path}`;
                document.getElementById('editBaseUrl').textContent = baseUrl;
                
                const operations = [
                    { method: 'GET', path: '', description: 'Get all items' },
                    { method: 'GET', path: '/:id', description: 'Get one item by ID' },
                    { method: 'POST', path: '', description: 'Create a new item' },
                    { method: 'PUT', path: '/:id', description: 'Update an existing item' },
                    { method: 'DELETE', path: '/:id', description: 'Delete an item' }
                ];
                
                referenceContainer.innerHTML = operations.map(op => `
                    <div class="crud-item">
                        <div class="crud-header">
                            <span class="method-badge method-${op.method.toLowerCase()}">${op.method}</span>
                            <code class="crud-path">${baseUrl}${op.path}</code>
                        </div>
                        <p class="crud-description">${op.description}</p>
                    </div>
                `).join('');
            }
            
            // Mostrar/ocultar tab de datos
            if (api.schema) {
                document.getElementById('dataTabBtn').style.display = 'block';
                loadEditDataItems();
            } else {
                document.getElementById('dataTabBtn').style.display = 'none';
            }
            
            // Resetear a primera tab
            switchEditTab('details');
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function closeEditSection() {
            document.getElementById('editSection').classList.add('hidden');
            document.getElementById('endpointsSection').classList.remove('hidden');
            document.getElementById('generatorSection').classList.add('hidden');
            
            // Actualizar nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[1].classList.add('active');
            
            // Actualizar breadcrumb
            document.getElementById('breadcrumb').textContent = 'My APIs';
            
            currentEditAPI = null;
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function switchEditTab(tab) {
            // Remover active de todos
            document.querySelectorAll('.edit-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.edit-tab-panel').forEach(p => p.classList.remove('active'));
            
            // Encontrar y activar el tab correcto
            const tabButtons = document.querySelectorAll('.edit-tab');
            tabButtons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(`'${tab}'`)) {
                    btn.classList.add('active');
                }
            });
            
            // Activar panel
            const panel = document.getElementById(`editTab-${tab}`);
            if (panel) {
                panel.classList.add('active');
            }
            
            if (tab === 'data' && currentEditAPI && currentEditAPI.schema) {
                loadEditDataItems();
            }
        }

        async function saveEditChanges() {
            const project_name = document.getElementById('editProjectInput').value.trim();
            const endpoint_name = document.getElementById('editEndpointInput').value.trim();
            const description = document.getElementById('editDescriptionInput').value.trim();

            if (!project_name || !endpoint_name || !description) {
                showEditAlert('All fields are required', 'error');
                return;
            }

            const new_path = `/${endpoint_name}`;

            try {
                const { error } = await supabase
                    .from('endpoints')
                    .update({
                        project_name: project_name,
                        path: new_path,
                        description: description
                    })
                    .eq('id', currentEditAPI.id);

                if (error) throw error;

                showEditAlert('Changes saved successfully! Reloading endpoints...', 'success');
                
                // Recargar endpoints del servidor
                await fetch(`${API_URL}/api/reload-endpoints`, { method: 'POST' });
                
                // Recargar lista local
                await cargarEndpoints();
                
                // Actualizar currentEditAPI
                currentEditAPI.project_name = project_name;
                currentEditAPI.path = new_path;
                currentEditAPI.description = description;
                
                // Actualizar hero y URL
                const newFullUrl = `${API_URL}/api/${project_name}${new_path}`;
                document.getElementById('editProjectBadge').textContent = project_name;
                document.getElementById('editApiName').textContent = endpoint_name.toUpperCase() + ' API';
                document.getElementById('editApiDescription').textContent = description;
                document.getElementById('editApiUrl').textContent = newFullUrl;
                
                // Actualizar API Reference si existe
                if (currentEditAPI.schema) {
                    const referenceContainer = document.getElementById('editApiReference');
                    const baseUrl = `${API_URL}/api/${project_name}${new_path}`;
                    document.getElementById('editBaseUrl').textContent = baseUrl;
                    
                    const operations = [
                        { method: 'GET', path: '', description: 'Get all items' },
                        { method: 'GET', path: '/:id', description: 'Get one item by ID' },
                        { method: 'POST', path: '', description: 'Create a new item' },
                        { method: 'PUT', path: '/:id', description: 'Update an existing item' },
                        { method: 'DELETE', path: '/:id', description: 'Delete an item' }
                    ];
                    
                    referenceContainer.innerHTML = operations.map(op => `
                        <div class="crud-item">
                            <div class="crud-header">
                                <span class="method-badge method-${op.method.toLowerCase()}">${op.method}</span>
                                <code class="crud-path">${baseUrl}${op.path}</code>
                            </div>
                            <p class="crud-description">${op.description}</p>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('Error:', error);
                showEditAlert('Error saving changes: ' + error.message, 'error');
            }
        }

        async function loadEditDataItems() {
            const wrapper = document.getElementById('editDataTableWrapper');
            const empty = document.getElementById('editDataEmpty');
            
            wrapper.style.display = 'none';
            empty.classList.add('hidden');
            
            const { data, error } = await supabase
                .from('endpoint_items')
                .select('*')
                .eq('endpoint_id', currentEditAPI.id)
                .order('created_at', { ascending: false });
            
            if (error) {
                showEditAlert('Error loading data: ' + error.message, 'error');
                return;
            }
            
            editDataItems = data || [];
            
            if (editDataItems.length === 0) {
                empty.classList.remove('hidden');
                document.getElementById('editDataCount').textContent = 'No items';
            } else {
                wrapper.style.display = 'block';
                document.getElementById('editDataCount').textContent = `${editDataItems.length} item${editDataItems.length !== 1 ? 's' : ''}`;
                renderEditDataTable();
            }
        }

        function renderEditDataTable() {
            const thead = document.getElementById('editDataTableHead');
            const tbody = document.getElementById('editDataTableBody');
            const fields = currentEditAPI.schema?.fields || [];
            const sampleItem = editDataItems[0]?.data || {};
            const fieldNames = fields.length > 0 ? fields.map(f => f.name) : Object.keys(sampleItem);
            
            thead.innerHTML = `<tr>${fieldNames.map(field => `<th>${field}</th>`).join('')}<th style="width: 140px;">Actions</th></tr>`;
            tbody.innerHTML = editDataItems.map(item => `<tr>${fieldNames.map(field => {
                const value = item.data[field];
                const displayValue = typeof value === 'object' ? JSON.stringify(value) : (value !== undefined && value !== null ? value : '-');
                const truncated = String(displayValue).length > 50 ? String(displayValue).substring(0, 50) + '...' : displayValue;
                return `<td title="${String(displayValue)}">${truncated}</td>`;
            }).join('')}<td><div style="display: flex; gap: 8px;"><button onclick="openEditItemInlineModal('${item.id}')" class="btn-edit"><i class="fas fa-edit"></i></button><button onclick="deleteEditDataItem('${item.id}')" class="btn-delete"><i class="fas fa-trash"></i></button></div></td></tr>`).join('');
        }

        function openCreateItemInlineModal() {
            editingItemId = null;
            document.getElementById('itemModalTitle').textContent = 'Add New Item';
            buildItemFormEdit();
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function openEditItemInlineModal(itemId) {
            editingItemId = itemId;
            document.getElementById('itemModalTitle').textContent = 'Edit Item';
            buildItemFormEdit(itemId);
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function buildItemFormEdit(itemId = null) {
            const form = document.getElementById('itemForm');
            const fields = currentEditAPI.schema?.fields || [];
            let itemData = {};
            if (itemId) {
                const item = editDataItems.find(i => i.id === itemId);
                itemData = item?.data || {};
            }
            form.innerHTML = fields.map(field => `<div class="form-group"><label class="form-label">${field.name}${field.required ? ' *' : ''}</label><input type="${field.type === 'number' ? 'number' : 'text'}" name="${field.name}" class="form-input" value="${itemData[field.name] || ''}" ${field.required ? 'required' : ''} placeholder="Enter ${field.name}"></div>`).join('');
        }

        async function deleteEditDataItem(itemId) {
            if (!confirm('Delete this item?')) return;
            const { error } = await supabase.from('endpoint_items').delete().eq('id', itemId);
            if (error) {
                showEditAlert('Error: ' + error.message, 'error');
                return;
            }
            loadEditDataItems();
        }

        async function saveDocumentation() {
            const docs = document.getElementById('editDocsInput').value.trim();
            
            try {
                const { error } = await supabase
                    .from('endpoints')
                    .update({ documentation: docs })
                    .eq('id', currentEditAPI.id);

                if (error) throw error;

                showEditAlert('Documentation saved!', 'success');
                currentEditAPI.documentation = docs;

            } catch (error) {
                showEditAlert('Error: ' + error.message, 'error');
            }
        }

        async function generateDocumentation() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            try {
                // Crear prompt para IA
                const prompt = `Generate comprehensive API documentation in Markdown format for this API:

Name: ${currentEditAPI.path.replace('/', '')}
Description: ${currentEditAPI.description}
Project: ${currentEditAPI.project_name}
${currentEditAPI.schema ? `Schema: ${JSON.stringify(currentEditAPI.schema.fields, null, 2)}` : ''}

Include:
- Overview
- Authentication (if needed)
- Endpoints
- Request/Response examples
- Error handling
- Rate limits (if applicable)

Write in a professional, clear style.`;

                const response = await fetch(`${API_URL}/api/generate-docs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, apiData: currentEditAPI })
                });

                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error || 'Error generating docs');
                
                document.getElementById('editDocsInput').value = data.documentation;
                showEditAlert('Documentation generated! Review and save.', 'success');

            } catch (error) {
                showEditAlert('Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Generate with AI';
            }
        }

        async function deleteEditAPI() {
            if (!confirm('Are you ABSOLUTELY sure? This action cannot be undone.')) return;
            if (!confirm('Last warning: This will permanently delete this API and all its data. Continue?')) return;

            try {
                await supabase.from('endpoint_items').delete().eq('endpoint_id', currentEditAPI.id);
                const { error } = await supabase.from('endpoints').delete().eq('id', currentEditAPI.id);
                if (error) throw error;

                showEditAlert('API deleted successfully', 'success');
                
                setTimeout(() => {
                    closeEditSection();
                    cargarEndpoints();
                }, 1500);

            } catch (error) {
                showEditAlert('Error: ' + error.message, 'error');
            }
        }

        function showEditAlert(message, type) {
            const container = document.getElementById('editAlertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function copyEditUrl(event) {
            const url = document.getElementById('editApiUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                const btn = event ? event.target.closest('.btn-copy') : document.querySelector('.btn-copy');
                if (!btn) return;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Error copying:', err);
                alert('URL copied to clipboard!');
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            
            // Guardar estado en localStorage
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        }

        // Restaurar estado del sidebar al cargar
        function restoreSidebarState() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                document.getElementById('sidebar').classList.add('collapsed');
            }
        }

        // ═══════════════════════════════════════════════════════════
        // ANALYTICS FUNCTIONS
        // ═══════════════════════════════════════════════════════════
        let analyticsChart = null;
        let analyticsData = null;

        async function loadAnalytics() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                const response = await fetch(`${API_URL}/api/analytics/summary`, {
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });
                
                const data = await response.json();
                analyticsData = data;
                
                // Update summary cards
                document.getElementById('totalRequests').textContent = data.totalRequests || 0;
                document.getElementById('requests24h').textContent = data.last24h || 0;
                document.getElementById('requests7d').textContent = data.last7d || 0;
                document.getElementById('requests30d').textContent = data.last30d || 0;
                
                // Populate API selector
                const apiSelect = document.getElementById('analyticsApiSelect');
                apiSelect.innerHTML = '<option value="">All APIs (Summary)</option>';
                data.endpoints?.forEach(ep => {
                    const option = document.createElement('option');
                    option.value = ep.id;
                    option.textContent = `${ep.project_name}/${ep.path} (${ep.requests} requests)`;
                    apiSelect.appendChild(option);
                });
                
                // Populate table
                const tbody = document.getElementById('analyticsTableBody');
                tbody.innerHTML = data.endpoints?.map(ep => `
                    <tr>
                        <td><strong>${ep.path}</strong></td>
                        <td><span style="padding: 4px 8px; background: #f5f5f5; border-radius: 6px; font-size: 12px;">${ep.project_name}</span></td>
                        <td><strong>${ep.requests}</strong></td>
                        <td>
                            <button class="btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="selectApiForAnalytics('${ep.id}')">
                                <i class="fas fa-chart-bar"></i> View Details
                            </button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #666;">No data yet</td></tr>';
                
                // Initialize chart with empty data
                initChart();
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function selectApiForAnalytics(endpointId) {
            document.getElementById('analyticsApiSelect').value = endpointId;
            loadEndpointAnalytics();
        }

        async function loadEndpointAnalytics() {
            const endpointId = document.getElementById('analyticsApiSelect').value;
            const range = document.getElementById('analyticsRangeSelect').value;
            
            if (!endpointId) {
                initChart();
                return;
            }
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                const response = await fetch(`${API_URL}/api/analytics/endpoint/${endpointId}?range=${range}`, {
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });
                
                const data = await response.json();
                
                // Update chart with time-grouped data
                const labels = Object.keys(data.metrics.timeGrouped).sort();
                const values = labels.map(label => data.metrics.timeGrouped[label]);
                
                updateChart(labels, values);
                
            } catch (error) {
                console.error('Error loading endpoint analytics:', error);
            }
        }

        function initChart() {
            const ctx = document.getElementById('requestsChart');
            
            if (analyticsChart) {
                analyticsChart.destroy();
            }
            
            analyticsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Requests',
                        data: [],
                        borderColor: '#FF5722',
                        backgroundColor: 'rgba(255, 87, 34, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            padding: 12,
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#FF5722',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        function updateChart(labels, data) {
            if (!analyticsChart) {
                initChart();
            }
            
            analyticsChart.data.labels = labels;
            analyticsChart.data.datasets[0].data = data;
            analyticsChart.update();
        }

        // ═══════════════════════════════════════════════════════════
        // DATASET UPLOAD FUNCTIONS
        // ═══════════════════════════════════════════════════════════
        let uploadedData = null;
        let detectedSchema = null;

        function initDropZone() {
            const dropZone = document.getElementById('dropZone');
            if (!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('dragging');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('dragging');
                });
            });

            dropZone.addEventListener('drop', handleDrop);
        }

        function switchMethodTab(method) {
            // Remove active from all tabs and panels
            document.querySelectorAll('.method-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.method-panel').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none';
            });
            
            // Find and activate the clicked tab
            const tabs = document.querySelectorAll('.method-tab');
            tabs.forEach(tab => {
                if ((method === 'ai' && tab.textContent.includes('Generate with AI')) ||
                    (method === 'upload' && tab.textContent.includes('Upload Dataset'))) {
                    tab.classList.add('active');
                }
            });
            
            // Show the corresponding panel
            const panelId = method === 'ai' ? 'aiGeneratorForm' : 'uploadGeneratorForm';
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.add('active');
                panel.style.display = 'block';
            }
        }

        // Drag & Drop handlers
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        function processFile(file) {
            // Validate file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                showUploadError('File too large. Maximum size is 10MB.');
                return;
            }
            
            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();
            
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileStats').textContent = `${(file.size / 1024).toFixed(2)} KB`;
            
            if (fileExtension === 'csv') {
                parseCSV(file);
            } else if (fileExtension === 'json') {
                parseJSON(file);
            } else {
                showUploadError('Unsupported file format. Please upload CSV or JSON.');
            }
        }
        
        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showUploadError('Error parsing CSV: ' + results.errors[0].message);
                        return;
                    }
                    
                    // Limit to 50K rows
                    const data = results.data.slice(0, 50000);
                    uploadedData = data;
                    
                    // Auto-detect schema
                    detectedSchema = detectSchema(data);
                    
                    // Show preview
                    showPreview(data, detectedSchema);
                    
                    document.getElementById('uploadBtn').disabled = false;
                },
                error: function(error) {
                    showUploadError('Error parsing CSV: ' + error.message);
                }
            });
        }
        
        function parseJSON(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data = JSON.parse(e.target.result);
                    
                    // If it's an object with an array property, extract it
                    if (!Array.isArray(data) && typeof data === 'object') {
                        const keys = Object.keys(data);
                        const arrayKey = keys.find(k => Array.isArray(data[k]));
                        if (arrayKey) {
                            data = data[arrayKey];
                        } else {
                            showUploadError('JSON must contain an array of objects');
                            return;
                        }
                    }
                    
                    if (!Array.isArray(data)) {
                        showUploadError('JSON must be an array of objects');
                        return;
                    }
                    
                    // Limit to 50K rows
                    data = data.slice(0, 50000);
                    uploadedData = data;
                    
                    // Auto-detect schema
                    detectedSchema = detectSchema(data);
                    
                    // Show preview
                    showPreview(data, detectedSchema);
                    
                    document.getElementById('uploadBtn').disabled = false;
                    
                } catch (error) {
                    showUploadError('Error parsing JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function detectSchema(data) {
            if (!data || data.length === 0) return null;
            
            const sample = data.slice(0, 100);
            const schema = { fields: [] };
            
            const firstRow = sample[0];
            Object.keys(firstRow).forEach(key => {
                const values = sample.map(row => row[key]).filter(v => v != null);
                
                let type = 'text';
                if (values.every(v => typeof v === 'number')) {
                    type = 'number';
                } else if (values.every(v => typeof v === 'boolean')) {
                    type = 'boolean';
                }
                
                schema.fields.push({
                    name: key,
                    type: type,
                    required: values.length === sample.length
                });
            });
            
            return schema;
        }
        
        function showPreview(data, schema) {
            document.getElementById('filePreview').classList.remove('hidden');
            
            // Preview table (first 5 rows)
            const preview = data.slice(0, 5);
            const headers = Object.keys(preview[0]);
            
            let tableHTML = '<table style="width: 100%; font-size: 12px; border-collapse: collapse;">';
            tableHTML += '<thead><tr>';
            headers.forEach(h => {
                tableHTML += `<th style="text-align: left; padding: 8px; border-bottom: 2px solid #ddd; font-weight: 600;">${h}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            preview.forEach(row => {
                tableHTML += '<tr>';
                headers.forEach(h => {
                    const value = row[h];
                    const displayValue = value === null || value === undefined ? '-' : String(value);
                    const truncated = displayValue.length > 30 ? displayValue.substring(0, 30) + '...' : displayValue;
                    tableHTML += `<td style="padding: 8px; border-bottom: 1px solid #eee;" title="${displayValue}">${truncated}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('previewTable').innerHTML = tableHTML;
            
            // Schema preview
            const schemaJSON = JSON.stringify(schema, null, 2);
            document.getElementById('schemaPreview').textContent = schemaJSON;
        }
        
        function clearFile() {
            uploadedData = null;
            detectedSchema = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadResult').classList.add('hidden');
            document.getElementById('uploadError').classList.add('hidden');
        }
        
        async function generateFromDataset() {
            const project_name = document.getElementById('uploadProjectInput').value.trim() || 'data';
            const api_name = document.getElementById('uploadApiNameInput').value.trim();
            
            if (!api_name) {
                showUploadError('Please provide an API name');
                return;
            }
            
            if (!uploadedData || !detectedSchema) {
                showUploadError('Please upload a dataset first');
                return;
            }
            
            const uploadLoading = document.getElementById('uploadLoading');
            const uploadResult = document.getElementById('uploadResult');
            const uploadError = document.getElementById('uploadError');
            const uploadBtn = document.getElementById('uploadBtn');
            
            uploadLoading.classList.remove('hidden');
            uploadResult.classList.add('hidden');
            uploadError.classList.add('hidden');
            uploadBtn.disabled = true;
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                const response = await fetch(`${API_URL}/api/create-from-dataset`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        project_name,
                        api_name,
                        schema: detectedSchema,
                        data: uploadedData,
                        description: `Dataset API with ${uploadedData.length} items`
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Error creating API');
                }
                
                uploadLoading.classList.add('hidden');
                uploadResult.classList.remove('hidden');
                
                const fullUrl = `${API_URL}/api/${data.endpoint.project_name}${data.endpoint.path}`;
                uploadResult.innerHTML = `
                    <div class="alert alert-success">
                        <strong>✓ API created successfully!</strong><br><br>
                        <code style="color: #065F46; font-weight: 500;">${fullUrl}</code><br><br>
                        <strong>${uploadedData.length}</strong> items imported
                    </div>
                `;
                
                clearFile();
                await cargarEndpoints();
                
            } catch (err) {
                uploadLoading.classList.add('hidden');
                showUploadError(err.message);
            } finally {
                uploadBtn.disabled = false;
            }
        }
        
        function showUploadError(message) {
            const uploadError = document.getElementById('uploadError');
            uploadError.innerHTML = `<div class="alert alert-error">${message}</div>`;
            uploadError.classList.remove('hidden');
            setTimeout(() => {
                uploadError.classList.add('hidden');
            }, 5000);
        }

        // ═══════════════════════════════════════════════════════════
        // KNOWLEDGE BASE FUNCTIONS
        // ═══════════════════════════════════════════════════════════
        let datasets = [];

        async function loadDatasets() {
            const loading = document.getElementById('datasetsLoading');
            const grid = document.getElementById('datasetsGrid');
            const empty = document.getElementById('datasetsEmpty');
            
            loading.classList.remove('hidden');
            grid.classList.add('hidden');
            empty.classList.add('hidden');
            
            try {
                const { data, error } = await supabase
                    .from('datasets')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                datasets = data || [];
                
                loading.classList.add('hidden');
                
                if (datasets.length === 0) {
                    empty.classList.remove('hidden');
                } else {
                    grid.classList.remove('hidden');
                    renderDatasets();
                }
            } catch (error) {
                console.error('Error loading datasets:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }

        function renderDatasets() {
            const grid = document.getElementById('datasetsGrid');
            
            grid.innerHTML = datasets.map(dataset => {
                const createdDate = new Date(dataset.created_at).toLocaleDateString();
                const sizeKB = (dataset.file_size / 1024).toFixed(2);
                
                return `
                    <div class="dataset-card">
                        <div class="dataset-card-header">
                            <div class="dataset-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="dataset-badge">${dataset.source_type}</div>
                        </div>
                        <h3 class="dataset-title">${dataset.name}</h3>
                        <p class="dataset-description">${dataset.description || 'No description'}</p>
                        <div class="dataset-meta">
                            <div class="dataset-meta-item">
                                <i class="fas fa-table"></i>
                                <span>${dataset.row_count} rows</span>
                            </div>
                            <div class="dataset-meta-item">
                                <i class="fas fa-file"></i>
                                <span>${sizeKB} KB</span>
                            </div>
                            <div class="dataset-meta-item">
                                <i class="fas fa-calendar"></i>
                                <span>${createdDate}</span>
                            </div>
                        </div>
                        <div class="dataset-actions">
                            <button class="btn-primary" style="flex: 1; padding: 10px;" onclick="createAPIFromDataset('${dataset.id}')">
                                <i class="fas fa-plus"></i> Create API
                            </button>
                            <button class="btn-secondary" style="padding: 10px 16px;" onclick="viewDataset('${dataset.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-secondary" style="padding: 10px 16px;" onclick="deleteDataset('${dataset.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showUploadDatasetModal() {
            // Por ahora, redirigir al generator con tab upload
            showSection('generator');
            switchMethodTab('upload');
        }

        async function createAPIFromDataset(datasetId) {
            const dataset = datasets.find(d => d.id === datasetId);
            if (!dataset) return;
            
            const apiName = prompt('API Name:', dataset.name.toLowerCase().replace(/\s+/g, '-'));
            if (!apiName) return;
            
            const projectName = prompt('Project Name:', 'data');
            if (!projectName) return;
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                // Obtener los datos del dataset
                const { data: items } = await supabase
                    .from('dataset_items')
                    .select('data')
                    .eq('dataset_id', datasetId);
                
                const dataArray = items?.map(i => i.data) || [];
                
                const response = await fetch(`${API_URL}/api/create-from-dataset`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        project_name: projectName,
                        api_name: apiName,
                        schema: dataset.schema,
                        data: dataArray,
                        description: dataset.description || `API from ${dataset.name}`,
                        dataset_id: dataset.id
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Error creating API');
                }
                
                alert('✓ API created successfully!');
                showSection('endpoints');
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating API: ' + error.message);
            }
        }

        function viewDataset(datasetId) {
            const dataset = datasets.find(d => d.id === datasetId);
            if (!dataset) return;
            
            alert(`Dataset: ${dataset.name}\n\nRows: ${dataset.row_count}\nSchema: ${JSON.stringify(dataset.schema, null, 2)}`);
        }

        async function deleteDataset(datasetId) {
            if (!confirm('Are you sure you want to delete this dataset?')) return;
            
            try {
                const { error } = await supabase
                    .from('datasets')
                    .delete()
                    .eq('id', datasetId);
                
                if (error) throw error;
                
                await loadDatasets();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting dataset: ' + error.message);
            }
        }

        init();
    </script>
</body>
</html>